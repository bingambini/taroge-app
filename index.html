<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Svaqi Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #f8f9fb; --black: #1c1c1e; --white: #ffffff; --gray: #8e8e93; --red: #ff3b30; --green: #34c759; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .view { height: 100vh; overflow-y: auto; display: none; padding-bottom: 140px; box-sizing: border-box; }
        .view.active { display: block; }

        .header { padding: 15px 20px; display: flex; align-items: center; background: var(--white); position: sticky; top: 0; z-index: 100; }
        .shop-name { font-size: 22px; font-weight: 900; color: var(--black); }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; }
        .card { background: var(--white); border-radius: 30px; padding: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.02); cursor: pointer; }
        .card img { width: 100%; aspect-ratio: 1; object-fit: contain; }
        .card h3 { margin: 10px 0 5px; font-size: 15px; font-weight: 800; color: var(--black); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .cat-scroll { display: flex; gap: 10px; padding: 10px 20px; overflow-x: auto; scrollbar-width: none; background: var(--bg); position: sticky; top: 0; z-index: 10; }
        .cat-pill { padding: 10px 20px; background: var(--white); border-radius: 20px; font-weight: 700; font-size: 14px; white-space: nowrap; cursor: pointer; transition: 0.2s; }
        .cat-pill.active { background: var(--black); color: white; }

        .tab-bar-container { position: fixed; bottom: 20px; left: 15px; right: 15px; z-index: 1000; }
        .tab-bar { background: var(--black); height: 75px; border-radius: 28px; display: flex; justify-content: space-around; align-items: center; }
        .tab-item { color: white; opacity: 0.4; font-size: 22px; flex: 1; text-align: center; position: relative; }
        .tab-item.active { opacity: 1; }
        .cart-badge { position: absolute; top: -5px; right: 28%; background: var(--red); color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: none; align-items: center; justify-content: center; border: 2px solid var(--black); font-weight: 900; }

        .btn-main { width: calc(100% - 40px); margin: 0 20px 30px; padding: 22px; border-radius: 25px; border: none; background: var(--black); color: white; font-size: 17px; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>

    <div id="home-view" class="view active">
        <div class="header"><div class="shop-name">Svaqi Store</div></div>
        <div id="products-grid" class="grid"></div>
    </div>

    <div id="catalog-view" class="view">
        <div style="padding:40px 25px 5px; font-size:28px; font-weight:900;">კატალოგი</div>
        <div id="category-list" class="cat-scroll"></div>
        <div id="catalog-grid" class="grid"></div>
    </div>

    <div id="cart-view" class="view">
        <div style="padding:40px 25px 10px; font-size:28px; font-weight:900;">კალათა</div>
        <div id="cart-list" style="padding: 0 20px;"></div>
        <div id="cart-empty" style="text-align:center; padding:50px; color:var(--gray);">კალათა ცარიელია</div>
        <div id="cart-footer" style="display:none; padding: 20px;">
            <div style="display:flex; justify-content:space-between; font-size:24px; font-weight:900; margin-bottom:20px;">
                <span>ჯამი:</span> <span id="cart-total">0₾</span>
            </div>
            <button class="btn-main" style="width:100%; margin:0;" onclick="tg.showAlert('შეკვეთა გაფორმებულია!')">გაფორმება</button>
        </div>
    </div>

    <div class="tab-bar-container">
        <div class="tab-bar">
            <div class="tab-item active" onclick="switchView('home', 0)"><i class="fa-solid fa-house"></i></div>
            <div class="tab-item" onclick="switchView('catalog', 1)"><i class="fa-solid fa-layer-group"></i></div>
            <div class="tab-item" onclick="switchView('cart', 2)">
                <i class="fa-solid fa-cart-shopping"></i>
                <span id="cart-badge" class="cart-badge">0</span>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const S_ID = '1jClKK61qjRoPT1OlhNegeuLSjGbbDjKLZFD-oi4WCAI';
        const BASE = `https://docs.google.com/spreadsheets/d/${S_ID}/gviz/tq?tqx=out:csv&gid=0`;

        let products = [], cart = [], categories = [];

        async function init() {
            try {
                const res = await fetch(BASE);
                const data = await res.text();
                const rows = data.split('\n').slice(1).map(l => l.split(',').map(c => c.replace(/^"|"$/g, '')));
                
                products = rows.filter(r => r[0]).map(r => ({
                    name: r[0], price: r[1], img: r[2]?.split(',')[0], cat: r[7] || "სხვა"
                }));

                categories = ["ყველა", ...new Set(products.map(p => p.cat))];
                renderGrid('products-grid', products.slice(0, 8));
                renderCats();
                renderGrid('catalog-grid', products);
            } catch(e) { console.error(e); }
        }

        function renderGrid(target, list) {
            document.getElementById(target).innerHTML = list.map(p => `
                <div class="card" onclick="addToCart('${p.name.replace(/'/g, "\\'")}')">
                    <img src="${p.img}">
                    <h3>${p.name}</h3>
                    <b>${p.price}₾</b>
                </div>
            `).join('');
        }

        function renderCats() {
            document.getElementById('category-list').innerHTML = categories.map(c => `
                <div class="cat-pill" onclick="filterCat('${c}')">${c}</div>
            `).join('');
        }

        function filterCat(c) {
            const filtered = c === "ყველა" ? products : products.filter(p => p.cat === c);
            renderGrid('catalog-grid', filtered);
        }

        function addToCart(name) {
            const p = products.find(x => x.name === name);
            if(p) { cart.push(p); updateCart(); tg.HapticFeedback.impactOccurred('light'); }
        }

        function updateCart() {
            document.getElementById('cart-badge').innerText = cart.length;
            document.getElementById('cart-badge').style.display = cart.length ? 'flex' : 'none';
            document.getElementById('cart-empty').style.display = cart.length ? 'none' : 'block';
            document.getElementById('cart-footer').style.display = cart.length ? 'block' : 'none';
            document.getElementById('cart-total').innerText = cart.reduce((a, b) => a + parseFloat(b.price), 0) + "₾";
            document.getElementById('cart-list').innerHTML = cart.map(p => `<div style="padding:10px; border-bottom:1px solid #eee;">${p.name} - ${p.price}₾</div>`).join('');
        }

        function switchView(v, i) {
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.getElementById(v + '-view').classList.add('active');
            document.querySelectorAll('.tab-item').forEach((e, idx) => e.classList.toggle('active', idx === i));
        }

        init();
    </script>
</body>
</html>
