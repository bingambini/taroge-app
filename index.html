<style>
    .price-bar { 
        position: sticky; bottom: 0; background: white; 
        padding: 20px 25px 40px; border-top: 1px solid #eee; 
        display: flex; flex-direction: column; gap: 15px; 
        box-shadow: 0 -10px 30px rgba(0,0,0,0.05);
    }
    
    .selection-summary {
        background: #f8f9fb; padding: 12px 15px; border-radius: 15px;
        font-size: 13px; font-weight: 600; color: var(--gray);
        opacity: 0; transition: 0.3s; transform: translateY(10px);
    }
    .selection-summary.visible { opacity: 1; transform: translateY(0); }
    .selection-summary strong { color: var(--black); font-weight: 800; }

    .action-row { display: flex; align-items: center; justify-content: space-between; width: 100%; }
    
    .buy-btn { 
        flex: 1; background: #eee; color: #aaa; margin-left: 20px;
        padding: 18px; border-radius: 20px; border: none; 
        font-size: 18px; font-weight: 800; transition: 0.3s;
        pointer-events: none;
    }
    .buy-btn.active { 
        background: var(--black); color: white; 
        pointer-events: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
</style>

<div id="details">
    <div class="price-bar">
        <div class="selection-summary" id="sel-summary">
            <div id="summary-text">გთხოვთ მიუთითოთ პარამეტრები</div>
        </div>
        
        <div class="action-row">
            <div id="det-price" style="font-size:26px; font-weight:900; letter-spacing:-1px;"></div>
            <button class="buy-btn" id="main-buy-btn" onclick="buy()">ყიდვა</button>
        </div>
    </div>
</div>

<script>
    // ... (init და renderOpts ფუნქციები იგივეა) ...

    function updateSelectionUI() {
        const summary = document.getElementById('sel-summary');
        const summaryText = document.getElementById('summary-text');
        const buyBtn = document.getElementById('main-buy-btn');

        const needsColor = currentP.colors.length > 0;
        const needsSize = currentP.sizes.length > 0;

        let info = `<strong>${currentP.name}</strong>`;
        let parts = [];
        
        if (selColor) parts.push(selColor);
        if (selSize) parts.push("ზომა: " + selSize);

        if (parts.length > 0) {
            info += " — " + parts.join(" / ");
            summary.classList.add('visible');
        }
        
        summaryText.innerHTML = info;

        // შემოწმება: ყველაფერი არჩეულია?
        if ((!needsColor || selColor) && (!needsSize || selSize)) {
            buyBtn.classList.add('active');
            buyBtn.innerText = "ყიდვა - " + currentP.price + "₾";
            tg.HapticFeedback.notificationOccurred('success');
        } else {
            buyBtn.classList.remove('active');
            buyBtn.innerText = "ყიდვა";
        }
    }

    // ეს ფუნქცია გამოიძახება ღილაკზე დაჭერისას
    window.activateBtn = (el, gridId, val) => {
        document.querySelectorAll(`#${gridId} .btn-opt`).forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        
        if(gridId === 'color-grid') selColor = val;
        if(gridId === 'size-grid') selSize = val;
        
        tg.HapticFeedback.selectionChanged();
        updateSelectionUI();
    };

    function buy() {
        // საბოლოო მონაცემები ბოტისთვის
        const orderData = {
            პროდუქტი: currentP.name,
            ფასი: currentP.price + "₾",
            ფერი: selColor || "არ არის მითითებული",
            ზომა: selSize || "არ არის მითითებული"
        };
        
        tg.sendData(JSON.stringify(orderData));
        tg.close();
    }
</script>
